---
title: "GitButler - 파일 미리보기 기여 후기"
tag:
  - GitButler
  - Git
  - Open-Source
star: true
date: "2024-10-20"
---

> 관련 이슈 1: https://github.com/gitbutlerapp/gitbutler/issues/2752  
> 관련 이슈 2: https://github.com/gitbutlerapp/gitbutler/issues/3093

이번 후기는 GitButler에서 바이너리 파일(이미지, 폰트파일 등)을 미리보기 기능을 구현한 것에 대한 후기이다.

![UI에서 미리보기 없이 Binary content not shown을 출력한다](https://github.com/user-attachments/assets/bc6269bd-14c0-4874-afc5-526d8ca82dfa)

관련 이슈를 살펴보면 바이너리 파일을 미리보기 기능을 구현하는 것에 대한 이슈가 있었다.  
UI에서 이미지는 미리보기 기능, 이미지 외의 파일에 대한 사이즈 정보를 보여주는 기능을 구현하는 것이 목표였다.

<!-- end -->

처음에는 프론트에서 로컬 파일의 경로를 읽어와서 보여주면 된다고 생각했다.  
하지만 프론트에서 미리보기를 구현하는건 단순한 문제였고, 백엔드에서 파일을 가져오는 방법에 대한 문제가 고민이 더 필요했다.

## 문제 파악

> 해결 시도: https://github.com/gitbutlerapp/gitbutler/pull/4852  
> 관련 이슈 3: https://github.com/gitbutlerapp/gitbutler/issues/4957

처음에는 프론트에서 로컬 파일을 가져와 보여주는 방법을 시도했다.
Tauri에서 로컬 경로에 대한 파일을 가져와 변환하는 방법을 사용했고 [convertFileSrc](https://v1.tauri.app/v1/api/js/tauri/#convertfilesrc)를 사용하면 파일을 보여줄 수 있다.

이 방법의 문제점은 **파일 경로가 조작되었을 때 보안 문제가 발생할 수 있다는 것이다**.  
클라이언트에서 로컬 파일 경로에 접근을 모두 허용하는 것은 "**경로 조작 공격**"같은 보안 문제가 발생할 수 있다.  
백엔드에서 git 저장소에 대한 파일만 내보내는 방법을 사용하면 보안 문제를 해결할 수 있다.

마침 다른 메인테이너가 git 저장소의 pull request template을 가져오는 함수를 구현하고 있었고,  
이를 활용해 백엔드에서 바이너리 파일을 가져오는 방법을 시도했다.

## 해결 방법

> 해결: https://github.com/gitbutlerapp/gitbutler/pull/5089

백엔드에서 바이너리 파일을 가져오는 함수를 구현하는 이슈가 다른 사람에게 할당되었고,  
구현 되기를 기다리는데 시간이 걸렸지만 이슈를 할당받은 사람이 로컬 빌드에 실패해서 다시 내가 할당받아 해결했다.

백엔드에서 git 저장소에서 바이너리 파일을 조회하려면 다음과 같은 조건을 고려해야한다.

1. untracked 상태
2. git에 commited된 상태
3. 워크트리와 인덱스에서 삭제된 상태

untracked 상태는 워크트리에 존재하지 않는 상태이고,  
git에 commited된 상태는 워크트리에 존재하는 상태이고,  
워크트리와 인덱스에서 삭제된 상태는 워크트리에 존재하지만 인덱스에 존재하지 않는 상태이다.  

무슨 차이냐면,

untracked 상태는 워크트리에 존재하지 않기 때문에 status를 조회해서 로컬 파일을 읽어와야한다.  
git에 commited된 상태는 HEAD에 존재하기 때문에 HEAD에서 파일을 읽어와야한다.  
워크트리와 인덱스에서 삭제된 상태는 HEAD와 로컬에도 존재하지 않기 때문에  
워크트리 상에 파일이 존재했던 hash를 조회해서 파일을 읽어와야한다.  

처음에는 이 3가지 상태 차이에 대한 이해가 부족했기 때문에 untracked와 기존의 HEAD에서 파일을 읽어오는 방법을 구현했다.
추가로 리뷰를 받고나서 3가지 상태를 고려해서 파일을 읽어오는 방법을 구현할 수 있었다.

## 기여 후기

> 후속 조치: https://github.com/gitbutlerapp/gitbutler/pull/5165

![0.13 버전부터 배포되어 미리보기 기능이 추가되었다](https://github.com/user-attachments/assets/4cdd20b2-1f3a-4519-9f90-b1d74cd506d9)

내가 기여한 기능이 적용되어있다는게 뿌듯했다. 그리고 몇 가지 아쉬움이 남았다.

바이너리 파일 미리보기를 구현하는데 총 걸린 기간은 1달이였다.  
관련 백엔드의 초안을 기다리는데 1주, 이슈가 중간에 다른사람에게 할당되면서 2주가 더 걸렸다.  
이미 팀 입장에서는 구현되는데 1달이라는 기간이 걸렸기 때문에 급하게 병합되는 부분이 있었다.  
코드를 좀 더 깔끔하게 작성하지 못했다는 생각이 든다.  

이후에 병합된 코드에 대한 후속 조치를 작성되었고,  
후속 조치에서 개선된 코드를 보고 리뷰를 받는 것보다 코드를 보는 것이 더 도움이 될 수 있다는 것을 배웠다.  
추가로 Git 객체에 대한 이해가 부족했다는 것에 대한 아쉬움이 있었다.  
관련 도서인 Pro Git을 읽어봐야겠다는 생각이 들었다.
